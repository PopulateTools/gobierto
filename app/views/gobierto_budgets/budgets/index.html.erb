<% title t('.title', year: @year) %>

<% content_for :breadcrumb_current_item do %>
  <h1>
    <%= link_to t('gobierto_budgets.layouts.menu_subsections.summary'), gobierto_budgets_budgets_path %>
  </h1>
<% end %>

<% content_for :body_attributes do %>
  <%== %Q{data-bubbles-data="#{bubbles_data_path(current_site)}" data-max-year="#{GobiertoBudgets::SearchEngineConfiguration::Year.last}"} %>
<% end %>

<div class="column">

  <div class="block">

    <div class="pure-g header_block_inline">
      <div class="pure-u-1 pure-u-md-12-24">
        <div class="inline_header">
          <h2 class="with_description p_h_r_1"><%= t('.header') %></h2>
          <%= render partial: 'gobierto_budgets/budgets/year_breadcrumb', locals: {path_calculation_method: :gobierto_budgets_budgets_path} %>
        </div>

        <p>
          <%= t('.description') %>
        </p>

        <%= render('gobierto_budgets/shared/data_updated_at') %>

        <p class="m_v_0_25"><%= link_to t('.budget_guide'), gobierto_budgets_budgets_guide_path %>.</p>
      </div>

      <div class="pure-u-1 pure-u-md-12-24 right">
        <%= image_tag('illustrations/personaliza.jpg', class: 'img_header m_v_4') %>
      </div>
    </div>

    <% cache(["gobierto_budgets/metric_boxes", current_site, I18n.locale, @year]) do %>
      <div class="pure-g metric_boxes">

        <div class="pure-u-1-2 pure-u-md-1-5 metric_box tipsit" title="<%= t('.expenses_per_inhabitant_tooltip') %>">
          <div class="inner">
            <h3><%= t('.expenses_per_inhabitant') %></h3>
            <div class="metric"><%= format_currency @site_stats.total_budget_per_inhabitant %></div>
          </div>
        </div>

        <div class="pure-u-1-2 pure-u-md-1-5 metric_box tipsit" title="<%= t('.total_expenses_tooltip') %>">
          <div class="inner">
            <h3><%= t('.total_expenses') %></h3>
            <div class="metric"><%= format_currency @site_stats.total_budget %></div>
          </div>
        </div>

        <div class="pure-u-1-2 pure-u-md-1-5 metric_box tipsit" title="<%= t('.executed_tooltip') %>">
          <div class="inner">
            <h3><%= t('.executed') %></h3>
            <% if @site_stats.total_budget_executed %>
              <div class="metric">
                <%= link_to gobierto_budgets_budgets_execution_path(year: GobiertoBudgets::SearchEngineConfiguration::Year.last) do %>
                  <%= format_currency @budgets_execution_summary[:last_expenses_execution] %>
                <% end %>
              </div>

              <div class="explanation explanation_bar">
                <% percentage = @budgets_execution_summary[:expenses_execution_percentage] %>
                <% percentage_bar_width = percentage > 100 ? 100 : percentage %>
                <div class="bar"><div class="line" style="width: <%= percentage_bar_width %>%"></div></div>
                <span><%= t('.executed_percent', percentage: percentage) %></span>
              </div>
            <% else %>
              <% percentage = @site_stats.total_budget_executed_percentage(@year - 1) %>
              <div class="metric"><span class="not_av"><%= t('.not_available_short') %></span></div>
              <div class="explanation">
                <%= t('.executed_percent_other_year_html', year: @year - 1, link: link_to("#{percentage} %", gobierto_budgets_budgets_execution_path)) %>
              </div>
            <% end %>
          </div>
        </div>

        <div class="pure-u-1-2 pure-u-md-1-5 metric_box tipsit" title="<%= t('.inhabitants_tooltip') %>">
          <div class="inner">
            <h3><%= t('.inhabitants') %></h3>
            <div class="metric"><%= number_with_precision @site_stats.latest_available(:population, @year)[:value], precision: 0, delimiter: '.' %></div>
            <% if @site_stats.latest_available(:population, @year)[:year] != @year %>
              <div class="explanation">
                <%= t('.data_of_year', year: @site_stats.latest_available(:population, @year)[:year]) %>
              </div>
            <% end %>
          </div>
        </div>

        <div class="pure-u-1-2 pure-u-md-1-5 metric_box tipsit" title="<%= t('.debt_tooltip') %>">
          <div class="inner">
            <h3><%= t('.debt') %></h3>
            <div class="metric"><%= format_currency @site_stats.latest_available(:debt, @year)[:value] %></div>
            <% if @site_stats.latest_available(:debt, @year)[:year] != @year %>
              <div class="explanation">
                <%= t('.at_years_end', year: @site_stats.latest_available(:debt, @year)[:year])%>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    <% end %>
  </div>

  <% pending do%>
    <div class="block">
      <h2><%= t('.stories_header') %></h2>

      <div class="pure-g stories_box">
        <a href="#" class="pure-u-md-1-3 pure-u-1 story_box">
          <div class="inner">
            <div class="bg-image" style="background-image: url(<%= image_url('stories/story_1') %>);"></div>

            <div class="padded">
              <h3 class="m_v_0_25"><%= t('.story_1.title') %></h3>
              <p class="m_v_0_25 soft"><%= t('.story_1.lede') %></p>
            </div>
          </div>
        </a>
        <a href="#" class="pure-u-md-1-3 pure-u-1 story_box">
          <div class="inner">
            <div class="bg-image" style="background-image: url(<%= image_url('stories/story_2') %>);"></div>

            <div class="padded">
              <h3 class="m_v_0_25"><%= t('.story_2.title') %></h3>
              <p class="m_v_0_25 soft"><%= t('.story_2.lede') %></p>
            </div>
          </div>
        </a>
        <a href="#" class="pure-u-md-1-3 pure-u-1 story_box">
          <div class="inner">
            <div class="bg-image" style="background-image: url(<%= image_url('stories/story_3') %>);"></div>

            <div class="padded">
              <h3 class="m_v_0_25"><%= t('.story_3.title') %></h3>
              <p class="m_v_0_25 soft"><%= t('.story_3.lede') %></p>
            </div>
          </div>
        </a>
      </div>
    </div>
  <% end %>

  <div class="block">
    <h2 class="with_description"><%= t('.main_budget_lines') %></h2>

    <div class="pure-g m_t_1">
      <div class="pure-u-1 pure-u-lg-11-24">
        <h3 class="center m_v_0 mt1"><%= t('.main_budget_lines_income') %></h3>
        <div class="graph vis-bubbles vis-bubbles-income"></div>
      </div>

      <div class="pure-u-1 pure-u-lg-1-24 bubble_legend_wrapper">
        <div class="bubble_legend"></div>
      </div>

      <div class="pure-u-1 pure-u-lg-11-24">
        <h3 class="center m_v_0 mt1"><%= t('.main_budget_lines_expense') %></h3>
        <div class="graph vis-bubbles vis-bubbles-expense"></div>
      </div>

      <div class="pure-u-1">
        <h3 class="m_v_0"><%= t('.main_budget_levels_timeline') %></h3>
        <div class="timeline"></div>
      </div>
    </div>
  </div>

  <% pending do %>
    <div class="block">
      <div class="pure-g banners">
        <div class="pure-u-md-2-3 pure-u-1 banner_block">
          <a href="#" class="inner center vertically_centered budget_receipt">

            <%= image_tag('illustrations/presupuestos.jpg', class: 'img-fluid') %>
            <h3 class="m_v_0_25"><%= t('.budget_receipt.title') %></h3>
            <p class="m_v_0_25"><%= t('.budget_receipt.intro') %></p>

          </a>
        </div>
        <div class="pure-u-md-1-3 pure-u-1 banner_block">
          <div class="inner budget_expense">
            <div class="soft"><strong><%= t('.budget_slides.title') %> </strong></div>
            <h3><%= t('.budget_slides.slide_1') %></h3>

            <div class="circle_figure">
              <div>36â‚¬</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  <% end %>

  <% cache(["gobierto_budgets/interesting_budget_lines", current_site, I18n.locale, @year]) do %>
    <div class="block">
      <h2 class="with_description"><%= t('.most_interesting_budget_lines') %></h2>
      <p class="description"><%= t('.most_interesting_budget_lines_description') %></p>

      <div class="graph" id="expense-treemap"
                         data-functional-url="<%= gobierto_budgets_budget_lines_treemap_path(@year, kind: GobiertoBudgets::BudgetLine::EXPENSE, area_name: 'functional', level: 2, format: :json) %>"
                         data-economic-url="<%= gobierto_budgets_budget_lines_treemap_path(@year, kind: GobiertoBudgets::BudgetLine::EXPENSE, area_name: 'economic', level: 2, format: :json) %>">
      </div>

      <table class="explore_slow">
        <thead class="screen-hidden">
          <tr>
            <th><%= t('.level_1_category') %></th>
            <th><%= t('.level_2_category') %></th>
            <th><%= t('.category_value') %></th>
            <th><%= t('.category_percentage') %></th>
            <th><span style="display:none" aria-hidden="true">WCAG 2.0 AA</span></th>
          </tr>
        </thead>

        <tbody>
          <% @interesting_expenses.group_by(&:parent_code).each do |parent_code, budget_lines| %>
              <tr class="group">
                <td class="level_1" rowspan="<%= budget_lines.count %>">
                  <%= budget_line_denomination @interesting_area, parent_code, GobiertoBudgets::BudgetLine::EXPENSE %>
                </td>
                <%= render partial: "gobierto_budgets/budgets/sub_budget_line",
                      locals: {sub_budget_line: budget_lines.first, last_item: false } %>
              </tr>
              <% budget_lines[1..-1].each_with_index do |budget_line, i| %>
                <tr>
                  <%= render partial: "gobierto_budgets/budgets/sub_budget_line",
                      locals: {sub_budget_line: budget_line, last_item: (i == budget_lines.length - 2) } %>
                </tr>
            <% end %>
          </tbody>
        <% end %>
      </table>
    </div>
  <% end %>

  <% if @budgets_execution_summary[:income_execution_percentage] && @budgets_execution_summary[:expenses_execution_percentage] %>
    <div class="block">
      <h2 class="with_description"><%= t('.execution_block.title') %></h2>
      <div class="pure-g half_description">
        <div class="pure-u-md-1 pure-u-1 block_1">
          <p class="description">
            <%= t('.execution_block.intro') %>

            <% if @budgets_data_updated_at %>
              <%= t('.execution_block.last_update', date: l(@budgets_data_updated_at, format: '%d %B %Y')) %>
            <% end %>
          </p>
        </div>
      </div>

      <div class="pure-g mega_bars m_v_1">
        <%= render 'mega_bar', {className: 'income', percentage: @budgets_execution_summary[:income_execution_percentage] } %>
        <%= render 'mega_bar', {className: 'expense', percentage: @budgets_execution_summary[:expenses_execution_percentage] } %>

        <div class="pure-u-1 center m_v_1">
          <%= link_to t('.execution_block.button'), gobierto_budgets_budgets_execution_path(year: GobiertoBudgets::SearchEngineConfiguration::Year.last), data: { turbolinks: false }, class: "button" %>
        </div>
      </div>
    </div>
  <% end %>

  <div class="featured_b_l block m_v_3" data-featured-budget-line="<%= gobierto_budgets_featured_budget_line_path(@year, template: 'gobierto_site_template') %>">
  </div>

  <div id="lines_chart_wrapper_separator" class="separator"></div>

  <% if budgets_comparison_context_table_enabled %>
    <div id="lines_chart_wrapper" class="pure-g" data-vis-lines role="tabpanel" aria-controlledby="per_person, total_budget">
      <div class=" pure-u-1 pure-u-md-1-2 block" >
        <h2><%= t('.at_a_glance') %></h2>

        <div id="lines_chart"></div>
      </div>

      <div class="pure-u-1 pure-u-md-1-2 block">
        <h2><%= t('.context') %></h2>

        <div id="lines_tooltip"></div>
        <div class="help">
          <%= link_to t('.note_about_the_data'), APP_CONFIG["gobierto_budgets"]["data_note_url"], target: '_blank', title: t('.note_about_the_data_title'), class: 'tipsit-n' %>
        </div>
      </div>

      <div class="pure-u-1 pure-u-md-1-2">
        <div class="filter m_v_2" role="tablist" aria-label="<%= t('.visualize') %>">
          <%= link_to t('.per_person'), '#', class:'active',  data: {"line-widget-series" => "means", "line-widget-url" => gobierto_budgets_api_data_lines_path(organization_id: current_site.organization_id, year: @year, what: 'per_person', format: :json), "line-widget-type" => "per_person" }, role:'tab', tabindex:0, 'aria-selected' => 'true', id:'per_person', 'aria-controls' => 'lines_chart_wrapper' %>
          <%= link_to t('.in_total'), '#', class:'',  data: {"line-widget-series" => "means", "line-widget-url" => gobierto_budgets_api_data_lines_path(organization_id: current_site.organization_id, year: @year, what: 'total_budget', format: :json), "line-widget-type" => "total_budget" }, role:'tab', tabindex:-1, 'aria-selected' => 'false', id:'total_budget', 'aria-controls' => 'lines_chart_wrapper' %>
        </div>
      </div>
    </div>
  <% end %>

  <% if budgets_comparison_compare_municipalities.any? %>
    <div id="lines_chart_comparison_wrapper" class="pure-g" data-vis-lines role="tabpanel" aria-controlledby="per_person, total_budget">
      <div class=" pure-u-1 pure-u-md-1-2 block" >
        <h2><%= t('.at_a_glance') %></h2>

        <div id="lines_chart_comparison"></div>
      </div>

      <div class="pure-u-1 pure-u-md-1-2 block">
        <h2><%= t('.context') %></h2>

        <div id="lines_tooltip_comparison"></div>
        <div class="help">
          <%= link_to t('.note_about_the_data'), APP_CONFIG["gobierto_budgets"]["data_note_url"], target: '_blank', title: t('.note_about_the_data_title'), class: 'tipsit-n' %>
        </div>

        <% if budgets_comparison_show_widget %>
          <%= render 'gobierto_budgets/shared/compare' %>
        <% end %>
      </div>

      <div class="pure-u-1 pure-u-md-1-2">
        <div class="filter m_v_2" role="tablist" aria-label="<%= t('.visualize') %>">
          <%= link_to t('.per_person'), '#', class:'active',  data: {"line-widget-series" => "comparison", "line-widget-url" => gobierto_budgets_api_data_lines_path(comparison: budgets_comparison_compare_municipalities, organization_id: current_site.organization_id, year: @year, what: 'per_person', format: :json), "line-widget-type" => "per_person" }, role:'tab', tabindex:0, 'aria-selected' => 'true', id:'per_person', 'aria-controls' => 'lines_chart_wrapper' %>
          <%= link_to t('.in_total'), '#', class:'',  data: {"line-widget-series" => "comparison", "line-widget-url" => gobierto_budgets_api_data_lines_path(comparison: budgets_comparison_compare_municipalities, organization_id: current_site.organization_id, year: @year, what: 'total_budget', format: :json), "line-widget-type" => "total_budget" }, role:'tab', tabindex:-1, 'aria-selected' => 'false', id:'total_budget', 'aria-controls' => 'lines_chart_wrapper' %>
        </div>
      </div>
    </div>
  <% end %>

  <div class="separator"></div>

  <%= render partial: 'gobierto_budgets/budget_lines/explorer' %>

  <% if budget_lines_feedback_active? %>
    <%= render 'gobierto_budgets/shared/enough_information' %>
  <% end %>

  <%= render "shared/download_open_data" %>
</div>
